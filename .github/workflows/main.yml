# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  prepare:
    name: Prepare project
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Start Cache
      uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-        
    - name: Install Node Modules
      run: npm install
      
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
       - name: Run npm tests
         run: npm test
 
  build:
    name: Build Production Build
    runs-on: ubuntu-latest
    needs: [test]
    steps:
       - name: Build production 
         run: npm run build
  
  deploy:
     if: ${{github.ref == 'develop'}}
     name: Deploy to dev server
     runs-on: ubuntu-latest
     needs: [build]
     steps:
       - name: copy file via ssh key
         uses: appleboy/scp-action@master
         with:
           host: ${{ secrets.HOST }}
           username: ${{ secrets.USERNAME }}
           port: ${{ secrets.PORT }}
           key: ${{ secrets.KEY }}
           source: "build/"
           target: "/built/cheem.uk/"
           rm: true

  
